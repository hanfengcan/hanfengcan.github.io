<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nodemcu快速入门--docker编译固件 | 代码杂货店</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.f40fe9bd.css" as="style"><link rel="preload" href="/assets/js/app.7f2137d4.js" as="script"><link rel="preload" href="/assets/js/3.4cb54c3a.js" as="script"><link rel="prefetch" href="/assets/js/2.5bada26e.js"><link rel="prefetch" href="/assets/js/4.d8319661.js"><link rel="prefetch" href="/assets/js/5.d7360eb2.js"><link rel="prefetch" href="/assets/js/6.98d7c79c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f40fe9bd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">代码杂货店</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">首页</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>nodemcu</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/article/nodemcu/nodemcu快速入门.html" class="active sidebar-link">nodemcu快速入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/nodemcu/nodemcu快速入门.html#安装docker" class="sidebar-link">安装docker</a></li><li class="sidebar-sub-header"><a href="/article/nodemcu/nodemcu快速入门.html#编译固件" class="sidebar-link">编译固件</a></li><li class="sidebar-sub-header"><a href="/article/nodemcu/nodemcu快速入门.html#麻烦的解决" class="sidebar-link">麻烦的解决</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>vscode扩展</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>阿里IOT</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="nodemcu快速入门-docker编译固件"><a href="#nodemcu快速入门-docker编译固件" aria-hidden="true" class="header-anchor">#</a> nodemcu快速入门--docker编译固件</h1> <p></p><div class="table-of-contents"><ul><li><a href="#安装docker">安装docker</a></li><li><a href="#编译固件">编译固件</a><ul><li><a href="#选择想要编译的模块">选择想要编译的模块</a></li><li><a href="#修改串口波特率">修改串口波特率</a></li><li><a href="#关闭对浮点的支持">关闭对浮点的支持</a></li></ul></li><li><a href="#麻烦的解决">麻烦的解决</a><ul><li><a href="#启动镜像并编译固件">启动镜像并编译固件</a></li><li><a href="#进入容器">进入容器</a></li><li><a href="#编译失败">编译失败</a></li><li><a href="#wget失败">wget失败</a></li></ul></li></ul></div><p></p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>如果你不想折腾, 有个云编译可以选择. 具体看我以前写的文章, 入口在<a href="https://www.jianshu.com/p/78b1400aa56e" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <h2 id="安装docker"><a href="#安装docker" aria-hidden="true" class="header-anchor">#</a> 安装docker</h2> <p>如果你而已玩腻了nodemcu的云编译固件, 想自己编译或者需要修改某些代码实现更好玩的DIY.
使用docker来编译固件是一个不错的选择.</p> <p>要用docker来编译固件, 先要安装docker. 如果你是Windows 10 home版本, 则只能安装docker toolbox.</p> <p>这里简单的介绍toolbox环境下的docker使用.</p> <p>到<a href="https://docs.docker.com/toolbox/toolbox_install_windows/#how-to-uninstall-toolbox" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>下载安装docker toolbox. 安装完成后, 会出现3个快捷方式. <img src="/assets/img/icon-set.97a09cac.png" alt="快捷方式"></p> <p>选择QuickStart启动toolbox, 它会去下载个虚拟机镜像文件, <strong>确保网络可以正常使用</strong>.</p> <p>下载完后, 接着在窗口中使用<code>docker pull marcelstoer/nodemcu-build</code>获取镜像.</p> <p>最后使用下面这条命令行来编译固件</p> <p><code>docker run --rm -it -v //nodemcu-firmware:/opt/nodemcu-firmware marcelstoer/nodemcu-build build</code></p> <p>这里有个路径问题需要注意一下, 下载的default虚拟机默认与Windows共享的文件夹是C盘的users文件夹.
如果你不像把nodemcu的源码放到C盘的话, 需要向虚拟机添加一个路径. 比如向我这样子, 将固件共享到根目录.</p> <p><img src="/assets/img/path.f4ee9ba7.png" alt="配置路径"></p> <h2 id="编译固件"><a href="#编译固件" aria-hidden="true" class="header-anchor">#</a> 编译固件</h2> <p>不要忘记获取固件源码, <code>git clone https://github.com/nodemcu/nodemcu-firmware.git</code>.</p> <h3 id="选择想要编译的模块"><a href="#选择想要编译的模块" aria-hidden="true" class="header-anchor">#</a> 选择想要编译的模块</h3> <p>想云编译类似, 你可以选择自己想要的模块编译入固件. 位于路径<code>app\include\user_modules.h</code>的头文件中有一大堆宏定义, 类似于下面的操作可以开启或者关闭模块.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> LUA_USE_MODULES_TMR</span>
<span class="token comment">//#define LUA_USE_MODULES_TSL2561</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LUA_USE_MODULES_UART</span>
<span class="token comment">//#define LUA_USE_MODULES_U8G2</span>
<span class="token comment">//#define LUA_USE_MODULES_UCG</span>
<span class="token comment">//#define LUA_USE_MODULES_WEBSOCKET</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LUA_USE_MODULES_WIFI</span>
</code></pre></div><h3 id="修改串口波特率"><a href="#修改串口波特率" aria-hidden="true" class="header-anchor">#</a> 修改串口波特率</h3> <p>固件模块的串口波特率是115200, 如有需要调整默认波特率修改<code>app\include\user_config.h</code>文件中的<code>BIT_RATE_DEFAULT</code>值.
支持的串口波特率枚举值可以在<code>app\include\driver\uart.h</code>查到.</p> <h3 id="关闭对浮点的支持"><a href="#关闭对浮点的支持" aria-hidden="true" class="header-anchor">#</a> 关闭对浮点的支持</h3> <p>同样的,在user_config.h文件中, 使用LUA_NUMBER_INTEGRAL宏可以关闭对浮点的支持, 这样可以节省固件大小.
如果固件有读取温度传感器数据之类的应用则可能需要开启浮点支持</p> <p>更多编译配置项目, 可以从<a href="https://nodemcu.readthedocs.io/en/master/en/build/#build-options" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>获取.</p> <h2 id="麻烦的解决"><a href="#麻烦的解决" aria-hidden="true" class="header-anchor">#</a> 麻烦的解决</h2> <p>如果你从零开始搭建docker编译环境, 并且一次性成功. 那么, 可以说你足够的幸运. 如果遇到问题, 则下面的方法可能可以帮助到你</p> <h3 id="启动镜像并编译固件"><a href="#启动镜像并编译固件" aria-hidden="true" class="header-anchor">#</a> 启动镜像并编译固件</h3> <p>你不需要每次都通过 QuickStart 快捷方式来启动镜像. 尝试下面的命令行</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker-machine start default
docker run -it -v //nodemcu-firmware:/opt/nodemcu-firmware
</code></pre></div><h3 id="进入容器"><a href="#进入容器" aria-hidden="true" class="header-anchor">#</a> 进入容器</h3> <p>一个有趣的命令行, 可以进入容器. <code>ls /opt/</code>可以看到这个镜像支持的命令.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -it -v //nodemcu-firmware:/opt/nodemcu-firmware marcelstoer/nodemcu-build /bin/bash

root@8e70bdfc62f5:/opt/nodemcu-firmware<span class="token comment"># ls /opt/</span>
build  build-esp32  build-esp8266  cmd.sh  configure-esp32  lfs-image  nodemcu-firmware  read.me
</code></pre></div><h3 id="编译失败"><a href="#编译失败" aria-hidden="true" class="header-anchor">#</a> 编译失败</h3> <p>在执行build的时候, 会下载一个toolchain并解压. 但是可能因为系统权限问题, 解压的文件不完整, 导致编译失败</p> <p>这时候, 你需要在Windows系统下手动解压toolchain到<code>nodemcu-firmware\tools\toolchains\esp8266-linux-x86_64-20181106.0</code>.</p> <p>接着把toolchain复制到docker的虚拟机中解压.</p> <p>最后把Linux系统里的<code>esp8266-linux-x86_64-20181106.0\bin</code>目录下的内容复制到Windows对应目录中.</p> <h3 id="wget失败"><a href="#wget失败" aria-hidden="true" class="header-anchor">#</a> wget失败</h3> <p>编译的过程中, 会利用wget从GitHub上面获取SDK. 如果下载失败, 可以手动下载并保存到<code>nodemcu-firmware\cache</code>!</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/3.4cb54c3a.js" defer></script><script src="/assets/js/app.7f2137d4.js" defer></script>
  </body>
</html>
